{{ $currentPageSection := .Section }}
{{ $currentPageRelPermalink := .RelPermalink }}

<aside class="aside">
  <nav class="aside_nav">
    <ul>
      {{ range where .Site.Pages "Section" "" }}
        <li {{ if eq $currentPageRelPermalink .RelPermalink }}class="aside_item-current"{{ end }}>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        </li>
      {{ end }}
      {{ range .Site.Sections.ByWeight }}
        <li {{ if eq $currentPageSection .Section }}class="aside_item-current-section"{{ end }}>
          {{ $allPages := .RegularPages.ByWeight | append .Sections.ByWeight }}
          {{ $allPages := sort $allPages "Weight" }}
          <span class="aside_item-section"><b>{{ .LinkTitle | markdownify  }}</b></span>
          <ul>
            {{ range $allPages }}
              {{ if .Content }}
                <li {{ if eq $currentPageRelPermalink .RelPermalink }}class="aside_item-current"{{ end }}><a href="{{ .RelPermalink }}">{{ .LinkTitle | markdownify }}</a></li>
              {{ else }}
                <li><span class="aside_item-subsection">{{ .LinkTitle | markdownify }}</span></li>
              {{ end }}
              {{ if .IsSection }}
                <li>
                  <ul>
                    {{ range .RegularPages.ByWeight }}
                      <li {{ if eq $currentPageRelPermalink .RelPermalink }}class="aside_item-current"{{ end }}><a href="{{ .RelPermalink }}">{{ .LinkTitle | markdownify }}</a></li>
                    {{ end }}
                  </ul>
                </li>
              {{ end }}
            {{ end }}
         </ul>
        </li>
      {{ end }}
    </ul>
  </nav>
</aside>
